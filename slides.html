<html>
<head>
<title>Hell Freezes Over</title>
<link rel="stylesheet" type="text/css" href="slides.css" />
</head>

<body>
<div class="slide">
    <div class="title-block">
    <h1>Hell Freezes Over</h1>
    <div class="subtitle">Freezing Limbo modules to reduce Inferno's memory footprint</div>

    <div class="author">David Boddie &lt;<a href="mailto:david@boddie.org.uk">david@boddie.org.uk</a>&gt;</div>
    <div class="author"><a href="https://www.boddie.org.uk/david">https://www.boddie.org.uk/david</a></div>
    </div>
</div>

<div class="slide">
<h2>About me</h2>

<p>Background:</p>
<ul>
<li>Physics/Astronomy/Mathematics not Computer Science/Engineering</li>
<li>Technical Writer/Developer</li>
</ul>

<p>Interest in Inferno:</p>
<ul>
<li>Interested from a computing history perspective</li>
<li>Then wanted to try using something other than Linux</li>
<li>Now mostly trying to port Inferno to different devices</li>
</ul>
</div>

<div class="slide">
<h2>Context</h2>

<p>Small devices:</p>

<ul>
<li>Some flash memory, not much RAM</li>
<li>Examples:
  <ul>
  <li><a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f405-415.html">STM32F405</a> &ndash; Cortex-M4</li>
  <li><a href="https://www.raspberrypi.com/documentation/microcontrollers/rp2040.html">RP2040</a> &ndash; Cortex-M0+</li>
  </ul>
</li>
<li>Both use the Thumb-2 instruction set</li>
</ul>
<p>We'll talk about the STM32 MCU.</p>
</div>

<div class="slide">
<h2>Building Inferno on STM32</h2>

<p>Toolchain for Thumb instructions:</p>
<ul>
<li>Compiler: <tt>tc</tt>
<li>Assembler: <tt>5a</tt>
<li>Linker: <tt>tl</tt></li>
</ul>

<p>References:</p>
<ul>
<li><a href="https://dboddie.gitlab.io/inferno-diary/2022-01-29.html">Notes on the Inferno Thumb Compiler</a></li>
<li><a href="https://dboddie.gitlab.io/inferno-diary/2022-01-30.html">More Thumb Compiler Notes</a></li></ul>
</div>

<div class="slide">
<h2>Problems</h2>

<p>Two issues:</p>
<ol>
<li>A lot of data is copied into RAM</li>
<li>Loading a Limbo module has an overhead</li>
</ol>

<p>Thoughts:</p>
<ul>
<li>Not much we can do about issue 1
  <ul>
  <li>Modify the compiler and linker</li>
  <li>Use a <a href="https://8e.iwp9.org/sunspot.pdf">custom allocator</a>?</li>
  </ul>
</li>
<li>Issue 2 might be worth exploring</li>
</ul>
</div>

<div class="slide">
<h2>Limbo modules</h2>

<p>Dis files contain features like these:</p>
<ul>
<li>Magic number</li>
<li>Code</li>
<li>Types</li>
<li>Data</li>
<li>Links</li>
<li>Imports</li>
<li>Handlers</li>
</ul>

<p>See the <a href="https://inferno-os.org/inferno/man/6/dis.html">Dis object file</a> man page.</p>
</div>

<div class="slide">
<h2>Loading Limbo modules</h2>

<ul>
<li><tt>readmod()</tt> in <tt>libinterp/readmod.c</tt>:
  <ul>
  <li>Allocate RAM for the contents of a Dis file</li>
  <li><tt>parsemod()</tt> in <tt>libinterp/load.c</tt>:
    <ul>
    <li>Decode each section of the file
    <li>This involves allocating RAM for data structures</li>
    </ul>
  </li>
  </ul>
</li>
<li>Free the RAM containing the file data</li>
</ul>

Result is a <tt>Module</tt> struct with pointers to allocated memory.
</div>

<div class="slide">
<h2>Code section</h2>

<div class="spacer"></div>
<p>Just instructions, non-self-modifying:</p>

<pre>
; disdump dis/pause.dis
newcw     , $0, 44(fp)
recv      44(fp), 40(fp)
movp      0(mp), 44(fp)
ret
</pre>

<p>Why not move them into flash memory?</p>
</div>

<div class="slide">
<h2>Why not move them into flash memory?</h2>

<p>Decoding the Dis file expands the instructions.</p>

<ul>
<li>So need to expand them at kernel compile-time</li>
<li>Compile them into the kernel as read-only data (<em>&ldquo;freeze&rdquo;</em> them)</li>
<li>Then just point the interpreter at them</li>
</ul>

<p>The interpreter normally patches instructions at run-time.</p>

<ul>
<li>It creates <tt>Inst</tt> structures and patches branches</li>
<li>The compiler can't know where each <tt>Inst</tt> will be at run-time</li>
<li>But we can decide where in flash memory to put them</li>
<li>So we can patch the instructions ourselves at kernel compile-time</li>
</ul>
</div>

<div class="slide">
<h2>Practical problems</h2>

<div class="spacer-large"></div>
<ul>
<li>How to freeze Dis files?</li>
<li>How does the interpreter know which files are frozen?</li>
<li>How does the interpreter find frozen modules?</li>
<li>How do we automate this?</li>
</ul>
</div>

<div class="slide">
<h2>How to freeze a Dis file?</h2>

<ul>
<li>There is already code to read Dis files in <tt>libinterp/load.c</tt>
  <ul>
  <li>Create a <tt>freeze</tt> tool and borrow existing code</li>
  <li>Expand Dis code and compile it into the kernel</li>
  </ul>
</li>
<li>What do we put in the root file system instead of the original file?
  <ul>
  <li>Could put only the code section in the kernel</li>
  <li>Easier to put the whole file in the kernel</li>
  <li>Leave a placeholder in the root file system</li>
  </ul>
</ul>

<pre>
; xd dis/pause.fdis
0000000 c000fd15 2f646973 2f706175 73652e64
0000010 69730000
0000013
; cat dis/pause.fdis
��/dis/pause.dis;
</pre>

</div>

<div class="slide">
<h2>Which files are frozen and which are normal?</h2>

<div class="spacer"></div>
<ul>
<li>Use a different magic number and a token to identify the frozen module</li>
<li>Change the loader to do something different in <tt>parsemod()</tt>:
  <ul>
  <li>Normal magic number?
    <ul><li>Execute the function as normal</li></ul>
  </li>
  <li>New magic number?
    <ul>
    <li>Execute <tt>loadfrozen()</tt> instead</li>
    <li>A new function in <tt>libinterp/loadfrozen.c</tt></li>
    </ul>
  </li>
  </ul>
</li>
</ul>
</div>

<div class="slide">
<h2>Finding frozen modules</h2>

<p>We have:</p>
<ul>
<li>Converted Dis files in the kernel</li>
<li>Placeholder files in the root file system</li>
</ul>

<p>Interpreter loads a placeholder file:</p>
<ul>
<li>Checks for the new magic number and reads the token</li>
<li>Searches a linked list of structs to find the matching token and data</li>
<li>Calls the <tt>_loadfrozen()</tt> function
  <ul>
  <li>Does what <tt>parsemod()</tt> normally does</li>
  <li>Except that the code is already unpacked and ready to use</li>
  </ul>
</li>
</ul>
</div>

<div class="slide">
<h2>Missing pieces</h2>

<p>We need to initialize the linked list of frozen modules:</p>
<ul>
<li>Implement <tt>addfrozenmod()</tt> to register frozen modules</li>
<li>A new function in <tt>libinterp/loadfrozen.c</tt></li>
</ul>

<p>Still need to:</p>
<ul>
<li>Describe all the frozen modules</li>
<li>Register them when the kernel starts</li>
</ul>

<p>Let's do both of these together.</p>
</div>

<div class="slide">
<h2>Registering frozen modules</h2>

<p>The configuration file (<tt>stm32f405.conf</tt>) contains a <tt>root</tt>
section with entries like this:</p>
<pre>
    /dis/pause.dis  /dis/pause.fdis
</pre>

<p>In the <tt>mkfile</tt>:</p>
<ul>
<li><tt>mkfrozen</tt> finds <tt>.fdis</tt> entries in the configuration file
  <ul>
  <li>Runs <tt>freeze</tt> on the corresponding <tt>.dis</tt> files</li>
  <li>Creates a <tt>frozen.h</tt> file with calls to register modules</li>
  <li>This is included by <tt>frozen.c</tt> in <tt>initfrozen()</tt>
  </ul>
</li>
<li><tt>listfrozen</tt> creates a build rule for the frozen modules</li>
</ul>
</div>

<div class="slide">
<h2>Registering frozen modules</h2>

<p>At run-time:</p>
<ul>
<li><tt>main()</tt> calls <tt>initfrozen()</tt></li>
<li>Calls <tt>addfrozenmod()</tt> for each frozen module
  <ul>
  <li>Thanks to the macro in the generated <tt>frozen.h</tt> file</li>
  </ul>
</li>
</ul>

<p>The interpreter has a linked list of frozen modules, so:
<ul>
<li>It can load a placeholder file</li>
<li>Check the magic number</li>
<li>Look up the token to find frozen module data</li>
</ul>
</div>

<div class="slide">
<h2>Summary</h2>

<p>To freeze a module:</p>

<ul>
<li>Add a line to the <tt>root</tt> section of the configuration file</li>
<li>Make sure you add an <tt>.fdis</tt> source</li>
<li>
</ul>
</div>

<div class="slide">
<h2>Thanks</h2>

<ul>
<li>Charles Forsyth for compiler hints and tips</li>
<li>Michael Engel for discussions about microcontrollers</li>
</ul>

<p>Resources:</p>
<ul>
<li><a href="https://github.com/dboddie/inferno-os/tree/stm32f405">https://github.com/dboddie/inferno-os/tree/stm32f405</a></li>
<li><a href="https://dboddie.gitlab.io/inferno-diary">https://dboddie.gitlab.io/inferno-diary</a></li>
</ul>
</div>
